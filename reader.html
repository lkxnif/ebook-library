<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: blob: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' blob: data: https:; worker-src blob:; connect-src 'self' blob: https:; media-src blob:; frame-src 'self' blob: data:;">
    <meta name="referrer" content="no-referrer">
    <title>电子书阅读器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- JSZip 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 主要 CDN 源 -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <!-- 备用 CDN 源 -->
    <script>
        if (typeof ePub === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"><\/script>');
        }
    </script>
    <!-- 本地备用 -->
    <script>
        if (typeof ePub === 'undefined') {
            document.write('<script src="js/lib/epub.min.js"><\/script>');
        }
    </script>
    <style>
        #viewer {
            height: calc(100vh - 60px);
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            position: relative;
            overflow: hidden;
        }

        #viewer iframe {
            border: none;
            width: 100%;
            height: 100%;
        }

        .epub-container {
            background-color: var(--background-color) !important;
            position: absolute !important;
            width: 100% !important;
            height: 100% !important;
        }

        .epub-view {
            background-color: var(--background-color) !important;
        }

        .toolbar {
            height: 60px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .toolbar-title {
            flex-grow: 1;
            margin: 0 1rem;
            color: var(--text-color);
        }

        .toolbar-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        #progress {
            width: 100px;
        }

        #error-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            text-align: center;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-color);
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <a href="index.html" class="btn btn-outline-secondary" aria-label="返回">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="toolbar-title h6 mb-0" id="book-title">加载中...</h1>
        <div class="toolbar-controls">
            <button class="btn btn-outline-secondary" id="prev" aria-label="上一页">
                <i class="fas fa-chevron-left"></i>
            </button>
            <input type="range" class="form-range" id="progress" value="0" min="0" max="100" aria-label="阅读进度">
            <button class="btn btn-outline-secondary" id="next" aria-label="下一页">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <div id="viewer">
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div id="loading-status" class="mt-3 text-muted"></div>
        </div>
    </div>
    <div id="error-container" class="alert alert-danger" role="alert"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const errorContainer = document.getElementById('error-container');
            const viewer = document.getElementById('viewer');
            const loadingStatus = document.getElementById('loading-status');

            function showError(message) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                viewer.querySelector('.loading')?.remove();
            }

            function updateLoadingStatus(message) {
                if (loadingStatus) {
                    loadingStatus.textContent = message;
                }
            }

            try {
                const bookPath = decodeURIComponent(urlParams.get('book'));
                if (!bookPath) {
                    showError('未指定电子书文件');
                    return;
                }

                // 确保使用相对路径，并处理 GitHub Pages 的基础路径
                const baseUrl = document.querySelector('base')?.href || window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '/');
                const cleanPath = bookPath.replace(/^\/+/, '').replace(/^data\/+/, 'data/');
                const fullPath = new URL(cleanPath, baseUrl).href;

                updateLoadingStatus('正在加载电子书...');
                console.log('正在加载电子书:', fullPath);

                // 创建一个新的 Blob URL
                fetch(fullPath, {
                    headers: {
                        'Accept': 'application/epub+zip, application/pdf, application/octet-stream',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-cache'  // 禁用缓存以确保获取最新文件
                })
                    .then(response => {
                        if (!response.ok) {
                            console.error('HTTP错误:', response.status, response.statusText);
                            console.error('请求URL:', fullPath);
                            throw new Error(`HTTP error! status: ${response.status}, path: ${fullPath}`);
                        }
                        updateLoadingStatus('正在解析文件...');
                        return response.blob();
                    })
                    .then(blob => {
                        if (blob.size === 0) {
                            throw new Error('文件内容为空');
                        }

                        console.log('文件大小:', (blob.size / 1024 / 1024).toFixed(2) + 'MB');
                        updateLoadingStatus('正在初始化阅��器...');

                        // 直接使用 blob 初始化
                        const book = ePub(blob);

                        // 添加调试信息
                        book.ready.then(() => {
                            console.log('电子书准备就绪');
                            updateLoadingStatus('电子书准备就绪');
                        }).catch(error => {
                            console.error('电子书准备失败:', error);
                        });

                        const rendition = book.renderTo('viewer', {
                            width: '100%',
                            height: '100%',
                            spread: 'none',
                            flow: 'paginated',
                            minSpreadWidth: 800,
                            allowScriptedContent: true,
                            manager: 'default',
                            view: 'iframe'
                        });

                        // 设置渲染样式
                        rendition.themes.default({
                            'body': {
                                'padding': '20px',
                                'max-width': '100%',
                                'margin': '0 auto',
                                'background-color': 'var(--background-color)',
                                'color': 'var(--text-color)'
                            }
                        });

                        book.on('book:error', (error) => {
                            console.error('电子书加载错误:', error);
                            showError(`电子书加载错误: ${error.message || '未知错误'}`);
                        });

                        // 加载书籍
                        rendition.display().then(() => {
                            console.log('电子书显示成功');
                            updateLoadingStatus('加载完成');
                        }).catch(error => {
                            console.error('显示电子书失败:', error);
                            showError('加载电子书失败：' + (error.message || '未知错误'));
                        });

                        // 获取书籍标题
                        book.loaded.metadata.then(metadata => {
                            console.log('获取到书籍元数据:', metadata);
                            document.getElementById('book-title').textContent = metadata.title;
                            document.title = metadata.title + ' - 电子书阅读器';
                        }).catch(error => {
                            console.error('获取元数据失败：', error);
                        });

                        // 翻页控制
                        const prevButton = document.getElementById('prev');
                        const nextButton = document.getElementById('next');

                        prevButton.addEventListener('click', () => {
                            rendition.prev();
                        });

                        nextButton.addEventListener('click', () => {
                            rendition.next();
                        });

                        // 进度条控制
                        const progress = document.getElementById('progress');
                        book.loaded.navigation.then(nav => {
                            progress.max = nav.toc.length;
                        }).catch(error => {
                            console.error('加载目录失败：', error);
                        });

                        rendition.on('relocated', location => {
                            progress.value = location.start.percentage * 100;
                        });

                        progress.addEventListener('change', () => {
                            const percentage = progress.value / 100;
                            book.locations.total().then(total => {
                                const location = percentage * total;
                                rendition.display(location);
                            }).catch(error => {
                                console.error('更新进度失败：', error);
                            });
                        });

                        // 键盘���制
                        document.addEventListener('keyup', event => {
                            if (event.key === 'ArrowLeft') rendition.prev();
                            if (event.key === 'ArrowRight') rendition.next();
                        });

                        // 主题
                        const currentTheme = document.documentElement.getAttribute('data-theme');
                        if (currentTheme === 'dark') {
                            rendition.themes.default({
                                body: {
                                    color: '#ffffff',
                                    background: '#222222'
                                }
                            });
                        }

                        // 清理函数
                        window.addEventListener('beforeunload', () => {
                            URL.revokeObjectURL(blobUrl);
                        });
                    })
                    .catch(error => {
                        console.error('获取电子书文件失败:', error);
                        showError('获取电子书文件失败：' + (error.message || '未知错误'));
                    });

            } catch (error) {
                showError('初始化阅读器失败：' + (error.message || '未知错误'));
            }
        });
    </script>
</body>

</html>