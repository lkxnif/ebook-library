<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: blob: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https: blob:; img-src 'self' blob: data: https:; worker-src blob:; connect-src 'self' blob: https:; media-src blob:; frame-src 'self' blob: data:;">
    <meta name="referrer" content="no-referrer">
    <title>电子书阅读器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- JSZip 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 主要 CDN 源 -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <!-- 备用 CDN 源 -->
    <script>
        if (typeof ePub === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"><\/script>');
        }
    </script>
    <!-- 本地备用 -->
    <script>
        if (typeof ePub === 'undefined') {
            document.write('<script src="js/lib/epub.min.js"><\/script>');
        }
    </script>
    <style>
        :root {
            --sidebar-width: 300px;
            --toolbar-height: 40px;
            --border-color: #e0e0e0;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            border-right: 1px solid var(--border-color);
            background: var(--card-bg);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar.active {
            display: flex;
        }

        #toc-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        #toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #toc-list li {
            margin: 0.5rem 0;
        }

        #toc-list a {
            color: var(--text-color);
            text-decoration: none;
            display: block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        #toc-list a:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            height: var(--toolbar-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            gap: 0.5rem;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar-group:not(:last-child) {
            border-right: 1px solid var(--border-color);
            padding-right: 0.5rem;
            margin-right: 0.5rem;
        }

        .toolbar-title {
            flex: 1;
            margin: 0;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #viewer {
            flex: 1;
            overflow: hidden;
            background-color: var(--background-color);
            position: relative;
        }

        .btn-icon {
            padding: 0.25rem 0.5rem;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            border-radius: 4px;
        }

        .btn-icon:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .btn-icon i {
            font-size: 1rem;
        }

        #progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        #progress {
            flex: 1;
        }

        #page-info {
            white-space: nowrap;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 300px;
        }

        #search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        #search-input.searching {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .search-count {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
            min-width: 4rem;
            text-align: center;
            user-select: none;
        }

        .btn-icon.search-prev,
        .btn-icon.search-next {
            padding: 0.25rem;
        }

        .btn-icon.search-prev:disabled,
        .btn-icon.search-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            border-radius: 2px;
        }

        .search-current {
            background-color: rgba(255, 255, 0, 0.5);
            border-radius: 2px;
        }

        /* 添加字体设置面板样式 */
        #font-settings-panel {
            position: absolute;
            top: calc(var(--toolbar-height) + 5px);
            right: auto;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        #font-settings-panel.active {
            display: block;
        }

        .font-size-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon.active {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .font-family-select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* 搜索结果样式 */
        mark.search-highlight,
        mark.search-current {
            padding: 2px;
            border-radius: 2px;
            color: inherit;
        }

        mark.search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
        }

        mark.search-current {
            background-color: rgba(255, 165, 0, 0.5);
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 300px;
        }

        #search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        #search-input.searching {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .search-count {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
            min-width: 4rem;
            text-align: center;
            user-select: none;
        }

        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background-color);
        }

        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        #loading-status {
            margin-top: 1rem;
            color: var(--text-color);
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div id="sidebar">
            <div class="toolbar">
                <h2 class="h6 mb-0">目录</h2>
                <button class="btn-icon ms-auto" id="close-sidebar" aria-label="关闭目录">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="toc-container">
                <ul id="toc-list"></ul>
            </div>
        </div>
        <div class="content-container">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn-icon" id="toggle-sidebar" aria-label="显示/隐藏目录">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="index.html" class="btn-icon" aria-label="返回">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <h1 class="toolbar-title" id="book-title">加载中...</h1>
                <div class="toolbar-group">
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="搜索..." aria-label="搜索">
                    </div>
                </div>
                <div class="toolbar-group">
                    <button class="btn-icon" id="font-settings" aria-label="字体设置">
                        <i class="fas fa-font"></i>
                    </button>
                    <button class="btn-icon" id="theme-toggle" aria-label="切换主题">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <div class="toolbar-group">
                    <button class="btn-icon" id="prev" aria-label="上一页">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div id="progress-container">
                        <input type="range" class="form-range" id="progress" value="0" min="0" max="100"
                            aria-label="阅读进度">
                        <span id="page-info">0/0</span>
                    </div>
                    <button class="btn-icon" id="next" aria-label="下一页">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div id="viewer">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div id="loading-status" class="mt-3 text-muted"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="error-container" class="alert alert-danger" role="alert"
        style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
    </div>

    <div id="font-settings-panel">
        <div class="font-setting-group">
            <div class="font-size-buttons">
                <button class="btn-icon" data-size="small" title="小号字体">
                    <i class="fas fa-font" style="font-size: 0.85em;"></i>
                </button>
                <button class="btn-icon" data-size="medium" title="中号字体">
                    <i class="fas fa-font"></i>
                </button>
                <button class="btn-icon" data-size="large" title="大号字���">
                    <i class="fas fa-font" style="font-size: 1.15em;"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const errorContainer = document.getElementById('error-container');
            const viewer = document.getElementById('viewer');
            const loadingStatus = document.getElementById('loading-status');
            const sidebar = document.getElementById('sidebar');
            const toggleSidebar = document.getElementById('toggle-sidebar');
            const closeSidebar = document.getElementById('close-sidebar');
            const progress = document.getElementById('progress');
            const searchInput = document.getElementById('search-input');
            const themeToggle = document.getElementById('theme-toggle');
            const fontSettingsPanel = document.getElementById('font-settings-panel');
            const fontSettingsButton = document.getElementById('font-settings');
            let book;
            let rendition;
            const FONT_SIZES = {
                small: 80,
                medium: 100,
                large: 150
            };
            let currentFontSize = 'medium';
            let searchTimeout;
            let searchResults = [];
            let currentSearchIndex = -1;

            function showError(message) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                viewer.querySelector('.loading')?.remove();
            }

            function updateLoadingStatus(message) {
                if (loadingStatus) {
                    loadingStatus.textContent = message;
                }
            }

            // 侧边栏控制
            toggleSidebar.onclick = () => {
                sidebar.classList.toggle('active');
            };

            closeSidebar.onclick = () => {
                sidebar.classList.remove('active');
            };

            // 字体设置面板控制
            document.addEventListener('click', function (event) {
                // 如果点击的是字体设置按钮
                if (event.target === fontSettingsButton || fontSettingsButton.contains(event.target)) {
                    event.stopPropagation();
                    fontSettingsPanel.classList.toggle('active');
                    if (fontSettingsPanel.classList.contains('active')) {
                        const buttonRect = fontSettingsButton.getBoundingClientRect();
                        fontSettingsPanel.style.left = (buttonRect.left + buttonRect.width / 2) + 'px';
                    }
                }
                // 如果点击的不是面板内部且面板是打开的，则关闭面板
                else if (!fontSettingsPanel.contains(event.target) && fontSettingsPanel.classList.contains('active')) {
                    fontSettingsPanel.classList.remove('active');
                }
            });

            // 监听电子书区域的点击
            rendition?.on('click', () => {
                if (fontSettingsPanel.classList.contains('active')) {
                    fontSettingsPanel.classList.remove('active');
                }
            });

            // 字体大小控制
            fontSettingsPanel.querySelectorAll('[data-size]').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const size = button.dataset.size;
                    if (size in FONT_SIZES && rendition) {
                        currentFontSize = size;
                        rendition.themes.fontSize(`${FONT_SIZES[size]}%`);
                        localStorage.setItem('fontSize', size);

                        // 更新按钮状态
                        fontSettingsPanel.querySelectorAll('[data-size]').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.size === size);
                        });
                    }
                });
            });

            // 加载保存的字体大小设置
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize && savedFontSize in FONT_SIZES) {
                currentFontSize = savedFontSize;
                // 等待 rendition 初始化完成后应用字体大小
                const applyFontSize = () => {
                    if (rendition) {
                        const button = fontSettingsPanel.querySelector(`[data-size="${savedFontSize}"]`);
                        if (button) {
                            button.click();
                        }
                    }
                };
                // 在 book ready 后应用字体大小
                if (book) {
                    book.ready.then(applyFontSize);
                }
            }

            // 主题切换增强
            themeToggle.onclick = () => {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const newTheme = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                themeToggle.querySelector('i').className = `fas fa-${isDark ? 'sun' : 'moon'}`;

                if (rendition) {
                    const themes = {
                        light: {
                            body: {
                                color: '#000000',
                                background: '#ffffff'
                            }
                        },
                        dark: {
                            body: {
                                color: '#ffffff',
                                background: '#222222'
                            }
                        }
                    };
                    rendition.themes.default(themes[newTheme]);
                }

                // 保存主题设置
                localStorage.setItem('theme', newTheme);
            };

            // 加载保存的主题设置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeToggle.querySelector('i').className = `fas fa-${savedTheme === 'dark' ? 'sun' : 'moon'}`;
            }

            function highlightSearchResult(index) {
                if (index >= 0 && index < searchResults.length) {
                    console.log('高亮搜索结果:', index);
                    clearSearchHighlights();
                    currentSearchIndex = index;
                    const result = searchResults[index];

                    console.log('跳转到章节:', result.href);
                    rendition.display(result.href).then(() => {
                        rendition.hooks.content.register((contents) => {
                            try {
                                const doc = contents.document;
                                const searchText = searchInput.value.trim();

                                // 添加高亮样式
                                if (!doc.getElementById('search-style')) {
                                    const style = doc.createElement('style');
                                    style.id = 'search-style';
                                    style.textContent = `
                                        .search-highlight {
                                            background-color: #ffff00 !important;
                                        }
                                        .search-current {
                                            background-color: #ffff00 !important;
                                            outline: 2px solid #ffd700 !important;
                                        }
                                    `;
                                    doc.head.appendChild(style);
                                }

                                // 在文本中查找匹配
                                const body = doc.querySelector('body');
                                const text = body.textContent;
                                const pos = text.indexOf(result.text);

                                if (pos >= 0) {
                                    // 使用简单的文本查找
                                    const walker = doc.createTreeWalker(
                                        body,
                                        NodeFilter.SHOW_TEXT,
                                        null,
                                        false
                                    );

                                    let node;
                                    let currentPos = 0;

                                    // 找到包含目标文本的节点
                                    while (node = walker.nextNode()) {
                                        const nodeText = node.textContent;
                                        const newPos = currentPos + nodeText.length;

                                        if (currentPos <= pos && pos < newPos) {
                                            const localPos = pos - currentPos;
                                            try {
                                                const range = doc.createRange();
                                                range.setStart(node, localPos);
                                                range.setEnd(node, localPos + result.text.length);

                                                const span = doc.createElement('span');
                                                span.className = 'search-current';
                                                range.surroundContents(span);

                                                span.scrollIntoView({
                                                    behavior: 'smooth',
                                                    block: 'center'
                                                });
                                                break;
                                            } catch (e) {
                                                console.error('创建高亮标记时出错:', e);
                                            }
                                        }
                                        currentPos = newPos;
                                    }
                                }
                            } catch (error) {
                                console.error('处理搜索结果时出错:', error);
                            }
                        });
                    });

                    updateSearchButtons();
                }
            }

            function clearSearchHighlights() {
                try {
                    const iframe = document.querySelector('#epub-viewer iframe');
                    if (iframe && iframe.contentDocument) {
                        const highlights = iframe.contentDocument.querySelectorAll('.search-highlight, .search-current');
                        highlights.forEach(highlight => {
                            if (highlight.parentNode) {
                                highlight.parentNode.replaceChild(
                                    iframe.contentDocument.createTextNode(highlight.textContent),
                                    highlight
                                );
                            }
                        });
                    }
                } catch (error) {
                    console.error('清除高亮时出错:', error);
                }
            }

            // 添加搜索导航按钮和结果计数
            const searchContainer = document.querySelector('.search-container');

            const searchCount = document.createElement('span');
            searchCount.className = 'search-count';
            searchCount.textContent = '无结果';

            const prevSearchButton = document.createElement('button');
            prevSearchButton.className = 'btn-icon search-prev';
            prevSearchButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
            prevSearchButton.disabled = true;
            prevSearchButton.onclick = () => {
                if (currentSearchIndex > 0) {
                    highlightSearchResult(currentSearchIndex - 1);
                }
            };

            const nextSearchButton = document.createElement('button');
            nextSearchButton.className = 'btn-icon search-next';
            nextSearchButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
            nextSearchButton.disabled = true;
            nextSearchButton.onclick = () => {
                if (currentSearchIndex < searchResults.length - 1) {
                    highlightSearchResult(currentSearchIndex + 1);
                }
            };

            searchContainer.appendChild(prevSearchButton);
            searchContainer.appendChild(searchCount);
            searchContainer.appendChild(nextSearchButton);

            searchInput.addEventListener('input', () => {
                if (!book) {
                    console.log('书籍未加载，无法搜索');
                    return;
                }
                clearTimeout(searchTimeout);

                if (!searchInput.value.trim()) {
                    console.log('搜索内容为空，清除搜索结果');
                    clearSearchHighlights();
                    searchResults = [];
                    currentSearchIndex = -1;
                    updateSearchButtons();
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    const searchText = searchInput.value.trim();
                    if (searchText) {
                        try {
                            console.log('开始搜索:', searchText);
                            searchResults = [];
                            currentSearchIndex = -1;
                            clearSearchHighlights();

                            searchInput.classList.add('searching');
                            updateSearchButtons();

                            // 遍历所有章节
                            const spineItems = book.spine.items;
                            for (let item of spineItems) {
                                try {
                                    const contents = await book.load(item.href);
                                    if (!contents) continue;

                                    let text;
                                    if (contents instanceof Document) {
                                        text = contents.body.textContent;
                                    } else if (contents.documentElement) {
                                        text = contents.documentElement.textContent;
                                    } else if (typeof contents === 'string') {
                                        text = contents;
                                    } else {
                                        console.error('无法获取章节文本:', item.href);
                                        continue;
                                    }

                                    if (!text) continue;

                                    const lowerText = text.toLowerCase();
                                    const lowerSearchText = searchText.toLowerCase();
                                    let pos = 0;

                                    while ((pos = lowerText.indexOf(lowerSearchText, pos)) !== -1) {
                                        const actualText = text.substring(pos, pos + searchText.length);
                                        if (actualText.toLowerCase() === searchText.toLowerCase()) {
                                            searchResults.push({
                                                href: item.href,
                                                position: pos,
                                                text: actualText,
                                                context: text.substring(Math.max(0, pos - 50), pos) +
                                                    '[' + actualText + ']' +
                                                    text.substring(pos + actualText.length, Math.min(text.length, pos + actualText.length + 50))
                                            });
                                        }
                                        pos += 1;
                                    }
                                } catch (err) {
                                    console.error('搜索章节时出错:', err);
                                }
                            }

                            if (searchResults.length > 0) {
                                highlightSearchResult(0);
                            }
                            updateSearchButtons();
                        } finally {
                            searchInput.classList.remove('searching');
                        }
                    }
                }, 300);
            });

            function updateSearchButtons() {
                const prevButton = document.querySelector('.search-prev');
                const nextButton = document.querySelector('.search-next');
                const resultCount = document.querySelector('.search-count');

                if (prevButton && nextButton) {
                    prevButton.disabled = currentSearchIndex <= 0;
                    nextButton.disabled = currentSearchIndex >= searchResults.length - 1;
                }

                if (resultCount) {
                    resultCount.textContent = searchResults.length > 0
                        ? `${currentSearchIndex + 1}/${searchResults.length}`
                        : '无结果';
                }
            }

            try {
                const bookPath = decodeURIComponent(urlParams.get('book'));
                if (!bookPath) {
                    showError('未指定电子书文件');
                    return;
                }

                // 确保使用相对路径，并处理 GitHub Pages 的基础路径
                const baseUrl = document.querySelector('base')?.href || window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '/');
                const cleanPath = bookPath.replace(/^\/+/, '').replace(/^data\/+/, 'data/');
                const fullPath = new URL(cleanPath, baseUrl).href;

                updateLoadingStatus('正在加载电子书...');
                console.log('正在加载电子书:', fullPath);

                fetch(fullPath, {
                    headers: {
                        'Accept': 'application/epub+zip, application/pdf, application/octet-stream',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-cache'
                })
                    .then(response => {
                        if (!response.ok) {
                            console.error('HTTP错误:', response.status, response.statusText);
                            console.error('请求URL:', fullPath);
                            throw new Error(`HTTP error! status: ${response.status}, path: ${fullPath}`);
                        }
                        updateLoadingStatus('正在解析文件...');
                        return response.blob();
                    })
                    .then(blob => {
                        if (blob.size === 0) {
                            throw new Error('文件内容为空');
                        }

                        console.log('文件大小:', (blob.size / 1024 / 1024).toFixed(2) + 'MB');
                        updateLoadingStatus('正在初始化阅读器...');

                        viewer.querySelector('.loading')?.remove();

                        const viewerDiv = document.createElement('div');
                        viewerDiv.id = 'epub-viewer';
                        viewerDiv.style.height = '100%';
                        viewer.appendChild(viewerDiv);

                        book = ePub(blob);

                        book.ready.then(() => {
                            console.log('电子书准备就绪');
                            updateLoadingStatus('电子书准备就绪');

                            // 生成位置信息，增加精度
                            return book.locations.generate(2048).then(() => {
                                localStorage.setItem(
                                    `${book.key()}-locations`,
                                    book.locations.save()
                                );

                                // 更新进度条最大值为总页数
                                progress.max = 100;

                                // 设置初始页信息
                                const totalLocations = book.locations.length();
                                document.getElementById('page-info').textContent = `1/${totalLocations}`;
                            });
                        }).catch(error => {
                            console.error('电子书准备失败:', error);
                            throw error;
                        });

                        rendition = book.renderTo('epub-viewer', {
                            width: '100%',
                            height: '100%',
                            spread: 'none',
                            flow: 'scrolled-doc',
                            allowScriptedContent: true,
                            manager: 'continuous',
                            sandbox: ['allow-scripts', 'allow-same-origin', 'allow-popups'],
                        });

                        // 处理图片路径
                        rendition.hooks.content.register((contents) => {
                            const images = contents.document.querySelectorAll('img');
                            images.forEach(img => {
                                if (img.src.startsWith('http://127.0.0.1:5500/')) {
                                    // 获取图片的相对路径
                                    const relativePath = img.src.replace('http://127.0.0.1:5500/', '');
                                    // 使用 blob URL
                                    book.archive.getBlob(relativePath).then(blob => {
                                        img.src = URL.createObjectURL(blob);
                                    }).catch(error => {
                                        console.error('加载图片失败:', error);
                                    });
                                }
                            });
                        });

                        // 监听 iframe 内的点击事件
                        rendition.on('rendered', (section) => {
                            const iframe = document.querySelector('#epub-viewer iframe');
                            if (iframe) {
                                iframe.contentDocument.addEventListener('click', () => {
                                    if (fontSettingsPanel.classList.contains('active')) {
                                        fontSettingsPanel.classList.remove('active');
                                    }
                                });
                            }
                        });

                        // 设置基本样式
                        rendition.themes.default({
                            'body': {
                                'padding': '20px 15%',
                                'max-width': '100%',
                                'margin': '0 auto',
                                'font-family': 'system-ui, -apple-system, sans-serif',
                                'line-height': '1.8',
                                'background-color': 'var(--background-color)',
                                'color': 'var(--text-color)',
                                'text-align': 'justify'
                            },
                            'p': {
                                'margin-bottom': '1em',
                                'text-indent': '2em'
                            },
                            'img': {
                                'max-width': '100%',
                                'height': 'auto',
                                'display': 'block',
                                'margin': '1em auto'
                            },
                            '@media screen and (max-width: 800px)': {
                                'body': {
                                    'padding': '20px 5%'
                                }
                            }
                        });

                        // 设置默认字体大小
                        rendition.themes.fontSize('18px');

                        // 加载目录
                        book.loaded.navigation.then(nav => {
                            const tocList = document.getElementById('toc-list');
                            function createTocItems(items, level = 0) {
                                return items.map(item => {
                                    const li = document.createElement('li');
                                    const a = document.createElement('a');
                                    a.href = '#';
                                    a.textContent = item.label;
                                    a.style.paddingLeft = `${level * 1.5}rem`;
                                    a.onclick = (e) => {
                                        e.preventDefault();
                                        rendition.display(item.href);
                                    };
                                    li.appendChild(a);
                                    if (item.subitems?.length) {
                                        const ul = document.createElement('ul');
                                        ul.style.listStyle = 'none';
                                        ul.style.padding = '0';
                                        ul.append(...createTocItems(item.subitems, level + 1));
                                        li.appendChild(ul);
                                    }
                                    return li;
                                });
                            }

                            if (nav.toc?.length) {
                                tocList.append(...createTocItems(nav.toc));
                            }

                            progress.max = nav.toc.length;
                        }).catch(error => {
                            console.error('加载目录失败：', error);
                        });

                        book.on('book:error', (error) => {
                            console.error('电子书加载错误:', error);
                            showError(`电子书加载错误: ${error.message || '未知错误'}`);
                        });

                        rendition.display().then(() => {
                            console.log('电子书显示成功');
                            updateLoadingStatus('加载完成');
                        }).catch(error => {
                            console.error('显示电子书失败:', error);
                            showError('加载电子书失败：' + (error.message || '未知错误'));
                        });

                        book.loaded.metadata.then(metadata => {
                            console.log('获取到书籍元数据:', metadata);
                            document.getElementById('book-title').textContent = metadata.title;
                            document.title = metadata.title + ' - 电子书阅读器';
                        }).catch(error => {
                            console.error('获取元数据失败：', error);
                        });

                        // 翻页控制
                        const prevButton = document.getElementById('prev');
                        const nextButton = document.getElementById('next');

                        prevButton.addEventListener('click', () => {
                            rendition.prev();
                        });

                        nextButton.addEventListener('click', () => {
                            rendition.next();
                        });

                        // 面信息更���
                        rendition.on('relocated', location => {
                            const currentLocation = book.locations.locationFromCfi(location.start.cfi);
                            const totalLocations = book.locations.length();

                            // 更新度条和页码
                            progress.value = (currentLocation / totalLocations) * 100;
                            document.getElementById('page-info').textContent = `${currentLocation}/${totalLocations}`;
                        });

                        // 进度条控制
                        progress.addEventListener('input', () => {
                            const percentage = progress.value / 100;
                            const totalLocations = book.locations.length();
                            const targetLocation = Math.round(percentage * totalLocations);
                            const cfi = book.locations.cfiFromLocation(targetLocation);

                            if (cfi) {
                                rendition.display(cfi);
                                document.getElementById('page-info').textContent = `${targetLocation}/${totalLocations}`;
                            }
                        });

                        // 键盘控制
                        document.addEventListener('keyup', event => {
                            if (event.key === 'ArrowLeft') rendition.prev();
                            if (event.key === 'ArrowRight') rendition.next();
                        });

                        // 主题
                        const currentTheme = document.documentElement.getAttribute('data-theme');
                        if (currentTheme === 'dark') {
                            rendition.themes.default({
                                body: {
                                    color: '#ffffff',
                                    background: '#222222'
                                }
                            });
                        }

                        // 清理数
                        window.addEventListener('beforeunload', () => {
                            URL.revokeObjectURL(blobUrl);
                        });
                    })
                    .catch(error => {
                        console.error('获取电子书文件失败:', error);
                        showError('获取电子书文件失败：' + (error.message || '未知错误'));
                    });

            } catch (error) {
                showError('初始化阅读器失败：' + (error.message || '未知错误'));
            }
        });
    </script>
</body>

</html>